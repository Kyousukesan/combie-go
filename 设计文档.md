# Combine 组件文档

## 1. 概述

**Combine** 是一个 Go 语言通用数据处理组件，核心目标是：

- **输入**：`[]struct`（字段带 tag）
- **处理**：根据 tag 调用自定义函数修改字段值或进行聚合计算
- **并行**：支持多聚合函数并发执行（可选开启）
- **扩展**：支持闭包函数和函数名注册
- **输出**：字段支持写入结构体字段或调用输出函数
- **上下文**：聚合函数可访问组件级上下文 `combineCtx`

---

## 2. 功能目标

1. **字段处理**
    - 按 tag 调用注册的自定义函数修改字段值
    - 支持单条处理和聚合处理

2. **聚合计算**
    - 对 list 中所有带同一 tag 的字段聚合成一个 list
    - 聚合函数返回 `map[key]value`
    - key 对应原 list 元素（如 struct 指针或唯一标识字段），value 为聚合结果
    - 聚合函数可并发执行，通过 `WithConcurrent` 控制
    - 聚合函数可访问组件上下文 `combineCtx`

3. **函数注册**
    - 支持闭包函数直接注册
    - 支持函数名注册，并通过 interface 类型约束输入输出参数

4. **tag 支持**
    - tag 定义函数名和输出字段
    - 格式：
      ```
      combine:"函数名,输出字段"
      ```
    - 输出字段可以是字段名，也可以是输出函数（通过前缀如 `fn:` 标记）
    - 例子：
      ```go
      type Item struct {
          ID       int     `combine:"id_handler,ID"`
          Name     string  `combine:"uppercase,Name"`
          Score    int     `combine:"avg_score,fn:SetAvg"`
          AvgScore float64
      }
 
      func SetAvg(item *Item, value any) {
          item.AvgScore = value.(float64)
      }
      ```

---

## 3. 使用说明

### 3.1 初始化组件（Option 模式）

```go
// Option 定义
type Option func(*Combine)

func WithConcurrent() Option {
    return func(c *Combine) {
        c.concurrent = true
    }
}

func WithCtx(ctx map[string]any) Option {
    return func(c *Combine) {
        c.combineCtx = ctx
    }
}
```

```go
// 构造函数
func NewCombine(opts ...Option) *Combine {
    c := &Combine{
        concurrent: false,          // 默认不并行
        combineCtx: make(map[string]any),
    }
    for _, opt := range opts {
        opt(c)
    }
    return c
}
```

**使用示例：**

```go
combine := NewCombine(
    WithConcurrent(), // 可选：需要并行时才加
    WithCtx(map[string]any{"factor": 1.5, "env":"prod"}),
)
```

---

### 3.2 注册处理函数

#### 闭包注册
```go
combine.Register("uppercase", func(v any) any {
    return strings.ToUpper(v.(string))
})
```

#### 聚合函数注册
```go
func AvgScore(values []any, combineCtx map[string]any) map[any]any {
    // 聚合逻辑，可以使用 combineCtx 中的上下文信息
    return nil
}
combine.RegisterAggregate("avg_score", AvgScore)
```

---

### 3.3 处理数据

```go
items := []Item{
    {ID:1, Name:"alice", Score:90},
    {ID:2, Name:"bob", Score:80},
}

combine.Process(items) // 输出修改后的 items
```

---

## 4. 功能设计

### 4.1 输入数据
- 类型：`[]struct`
- 字段通过 tag 指定函数、输出字段

### 4.2 函数注册机制
```go
combine.Register(tag string, f interface{})          // 单条处理
combine.RegisterAggregate(tag string, f interface{}) // 聚合处理
```
- 支持闭包或函数名
- 对函数名进行 interface 类型约束检查

### 4.3 执行逻辑

1. 遍历 list，扫描字段 tag
2. 解析 tag：函数名、输出字段
3. 收集字段值
4. 调用注册函数：
    - 单条处理 → 更新输出字段或调用输出函数
    - 聚合处理 → 返回 `map[key]value`，写回输出字段或调用输出函数，并传入 `combineCtx`
5. 并发控制：
    - `WithConcurrent()` → 多个聚合函数并发执行
    - 默认不开启并行

---

### 4.4 输出
- 返回修改后的 list，保持原有顺序
- 输出字段由 tag 中指定的字段或输出函数决定

---

## 5. 扩展能力

- 支持多 tag 聚合
- 支持一个字段绑定多个 tag
- 支持并发控制，提升大数据量处理效率
- 聚合函数可访问组件级上下文 `combineCtx`

---

## 6. 示例代码汇总

```go
package main

import (
    "strings"
)

type Item struct {
    ID       int     `combine:"combineItem,Items"`
    Name     string  `combine:"uppercase,Name"`
    Score    int     `combine:"avg_score,fn:SetAvg"`
    Items    []string 
    AvgScore float64
}

// 输出函数
func SetAvg(item *Item, value any) {
    item.AvgScore = value.(float64)
}

// Option 定义
type Option func(*Combine)

func WithConcurrent() Option {
    return func(c *Combine) {
        c.concurrent = true
    }
}

func WithCtx(ctx map[string]any) Option {
    return func(c *Combine) {
        c.combineCtx = ctx
    }
}

type Combine struct {
    concurrent bool
    combineCtx map[string]any
    // 省略函数注册表...
}

func NewCombine(opts ...Option) *Combine {
    c := &Combine{
        concurrent: false,
        combineCtx: make(map[string]any),
    }
    for _, opt := range opts {
        opt(c)
    }
    return c
}

func (c *Combine) Register(name string, fn interface{}) {
    // 注册逻辑...
}

func (c *Combine) Process(items interface{}) {
    // 执行逻辑...
}

func main() {
    combine := NewCombine(
        WithConcurrent(),
        WithCtx(map[string]any{"factor": 1.5, "env": "prod"}),
    )

    // 注册闭包
    combine.Register("uppercase", func(values []any, combineCtx map[string]any) map[any]any {
        
        result := make(map[string]struct{}, len(values))
        for _, v := range values {
            s := fmt.Sprint(v) // 转成 string
            result[s] = strings.ToUpper(s)
        }
        return result
    })

    // 注册闭包 批量聚合
    combine.Register("combineItem", func(values []any, combineCtx map[string]any) map[any]any {
        //...查询db
        items := make(map[int][]string)
        items[1] = []string{"bbb", "aaa", "ccc"}
        items[2] = []string{"sss"}
        return items
    })

    // 注册聚合函数
    combine.Register("avg_score", func(values []any, combineCtx map[string]any) map[any]any {
        // ...聚合逻辑
        m := make(map[int]string)
        m["alice"] = 20
        m["bob"] = 100
        return m
    })

    // 输入数据
    items := []Item{
        {ID: 1, Name: "alice", Score: 90},
        {ID: 2, Name: "bob", Score: 80},
    }

    // 执行
    combine.Process(items)

}
```

最后输出

```go
    {
        {ID: 1, Name: "alice", Score: 90, Items: []string{"bbb", "aaa", "ccc"}, AvgScore: 20},
        {ID: 2, Name: "bob", Score: 80, Items: []string{"sss"}, AvgScore: 100}
    }
        
```